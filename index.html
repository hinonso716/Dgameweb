<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>洛克人 – 變身完整版</title>
  <style>
    body {margin:0;background:#000;color:#fff;font-family:system-ui,sans-serif;overflow:hidden;}
    canvas {display:block;margin:0 auto;background:linear-gradient(to bottom,#001133,#000);}
    #ui {position:absolute;top:20px;left:20px;font-size:28px;z-index:10;}
    #level {position:absolute;top:20px;right:20px;font-size:28px;z-index:10;}
    #transform {position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);display:none;align-items:center;justify-content:center;z-index:100;color:#fff;font-size:80px;text-align:center;}
    .info {position:fixed;bottom:20px;left:50%;transform:translateX(-50%);color:#aaa;font-size:16px;}
  </style>
</head>
<body>
  <div id="ui">生命: <span id="lives">3</span>　分數: <span id="score">0</span></div>
  <div id="level">關卡 <span id="lvl">1</span>/3</div>
  <canvas id="c" width="1200" height="600"></canvas>
  <div id="transform"><div id="transText"></div></div>
  <p class="info">A/D移動 W跳 長按J蓄力射擊 • 撿彩色球換形態</p>

  <script>
    const canvas = document.getElementById('c');
    const ctx = canvas.getContext('2d');
    const G = 0.9, JUMP = -19, SPEED = 7;

    let player = {
      x: 100, y: 400, w: 50, h: 60,
      vx: 0, vy: 0, onGround: false,
      lives: 3, facing: 1, // 1=右 -1=左
      charge: 0, charging: false,
      form: 'normal' // normal, fire, electric
    };

    const forms = {
      normal: {color: '#00bfff', shot: '#00ffff', name: '正常形態'},
      fire:   {color: '#ff3000', shot: '#ff8800', name: '火焰洛克人'},
      electric:{color: '#00ff44', shot: '#aaff00', name: '電擊洛克人'}
    };

    let bullets = [], enemies = [], powerups = [], particles = [], platforms = [];
    let level = 1, score = 0, keys = {}, transformAnim = null;

    function loadLevel(l) {
      platforms = [
        {x:0,y:560,w:1200,h:40},
        ...Array.from({length: l*3}, (_,i)=>({
          x: 200 + i*300 + Math.random()*100,
          y: 400 + Math.random()*150,
          w: 150 + Math.random()*100,
          h: 20
        }))
      ];
      enemies = Array.from({length: 4+l*2},()=>({
        x:1200+Math.random()*400, y:500,
        vx: -2-l*0.3, hp:1+l, maxHp:1+l, w:40, h:50
      }));
      powerups = [
        {x:600,y:300,type:'form',form:'fire',w:40,h:40},
        {x:900,y:200,type:'form',form:'electric',w:40,h:40}
      ];
    }
    loadLevel(1);

    document.addEventListener('keydown',e=>keys[e.key.toLowerCase()]=true);
    document.addEventListener('keyup',e=>keys[e.key.toLowerCase()]=false);

    function transformTo(newForm) {
      if (player.form === newForm) return;
      transformAnim = {form:newForm, time:0};
      document.getElementById('transform').style.display = 'flex';
      document.getElementById('transText').textContent = forms[newForm].name;
      setTimeout(()=>{
        player.form = newForm;
        document.getElementById('transform').style.display = 'none';
        createParticles(player.x+player.w/2, player.y+player.h/2, forms[newForm].color, 50);
      }, 2000);
    }

    function update() {
      if (!keys) return;

      // 移動與面向
      player.vx = 0;
      if (keys['a']) { player.vx = -SPEED; player.facing = -1; }
      if (keys['d']) { player.vx = SPEED; player.facing = 1; }
      if (keys['w'] && player.onGround) player.vy = JUMP;

      // 蓄力射擊
      player.charging = keys['j'];
      if (player.charging) player.charge = Math.min(player.charge+20, 300);
      else if (player.charge > 0) {
        const power = player.charge/300;
        bullets.push({
          x: player.x + (player.facing>0 ? player.w : 0),
          y: player.y + player.h/2,
          vx: 12*player.facing*(1+power),
          size: 10+power*20,
          color: forms[player.form].shot
        });
        player.charge = 0;
      }

      player.vy += G;
      player.x += player.vx;
      player.y += player.vy;

      // 平台碰撞
      player.onGround = false;
      platforms.forEach(p=>{
        if (player.x < p.x+p.w && player.x+player.w > p.x &&
            player.y < p.y+p.h && player.y+player.h > p.y) {
          if (player.vy > 0) {
            player.y = p.y - player.h;
            player.vy = 0;
            player.onGround = true;
          }
        }
      });

      // 進關
      if (player.x > 1100) {
        level++;
        if (level > 3) { alert(`全關通關！最終分數：${score}`); location.reload(); }
        loadLevel(level);
        player.x = 50;
        score += 2000;
        document.getElementById('lvl').textContent = level;
      }

      // 子彈、敵人、道具、粒子更新（略，核心邏輯同上版）

      // 撿換形態道具
      powerups = powerups.filter(pu=>{
        if (player.x < pu.x+pu.w && player.x+player.w > pu.x &&
            player.y < pu.y+pu.h && player.y+player.h > pu.y) {
          if (pu.type==='form') transformTo(pu.form);
          return false;
        }
        return true;
      });

      document.getElementById('score').textContent = score;
      document.getElementById('lives').textContent = player.lives;
    }

    function draw() {
      ctx.clearRect(0,0,canvas.width,canvas.height);

      // 背景星星動態
      ctx.fillStyle = 'rgba(255,255,255,0.1)';
      for(let i=0;i<100;i++) ctx.fillRect(Math.random()*canvas.width,Math.random()*canvas.height,2,2);

      // 平台
      ctx.fillStyle = '#444';
      platforms.forEach(p=>ctx.fillRect(p.x,p.y,p.w,p.h));

      // 玩家（根據當前形態變色）
      const c = forms[player.form].color;
      ctx.fillStyle = c;
      ctx.shadowColor = c; ctx.shadowBlur = 30;
      ctx.fillRect(player.x+5,player.y+5,player.w-10,player.h-10);
      ctx.shadowBlur = 0;

      // 蓄力條
      if (player.charging) {
        ctx.fillStyle = 'rgba(255,255,255,0.8)';
        ctx.fillRect(player.x, player.y-15, (player.charge/300)*player.w, 8);
      }

      // 換形態道具（旋轉發光）
      powerups.forEach(pu=>{
        ctx.save();
        ctx.translate(pu.x+pu.w/2, pu.y+pu.h/2);
        ctx.rotate(Date.now()/300);
        ctx.fillStyle = pu.form==='fire'?'#ff3000':'#00ff44';
        ctx.shadowColor = ctx.fillStyle; ctx.shadowBlur = 40;
        ctx.fillRect(-pu.w/2,-pu.h/2,pu.w,pu.h);
        ctx.restore();
      });

      // 其他繪製（子彈、敵人、粒子）略，同上版邏輯
    }

    function loop() {
      update();
      draw();
      requestAnimationFrame(loop);
    }
    loop();
  </script>
</body>
</html>
