<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>洛克人 – 終極平衡版（難度合理 + 滿蓄金色光環 + 8-bit音樂）</title>
<style>
  body{margin:0;background:#000;overflow:hidden;font-family:system-ui,sans-serif;}
  canvas{background:#001133;border:12px solid #00ffff;box-shadow:0 0 70px #00ffff;display:block;}
  #ui{position:absolute;top:10px;left:10px;color:#fff;font-size:24px;z-index:10;background:rgba(0,0,0,0.6);padding:12px;border-radius:10px;}
  #level{position:absolute;top:10px;right:10px;color:#fff;font-size:24px;z-index:10;background:rgba(0,0,0,0.6);padding:12px;border-radius:10px;}
  #boss{position:absolute;top:70px;right:10px;color:#fff;font-size:24px;z-index:10;background:rgba(0,0,0,0.6);padding:12px;border-radius:10px;display:none;}
  #info{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);color:#00ffff;font-size:18px;background:rgba(0,0,0,0.6);padding:12px;border-radius:10px;}
</style>
</head>
<body>

<div id="ui">生命 <span id="lives">3</span>　分數 <span id="score">0</span>　武器 <span id="weapon">普通</span></div>
<div id="level">關卡 <span id="lvl">1</span>/3</div>
<div id="boss">BOSS 血量 <span id="bossHp">0</span></div>

<canvas id="c" width="1200" height="600"></canvas>

<div id="info">A/D移動　W跳　長按J蓄力射擊　撿道具換形態　滿蓄力有金色光環！</div>

<!-- 8-bit經典戰鬥音樂（來自經典洛克人） -->
<audio id="bgm" loop>
  <source src="https://cdn.jsdelivr.net/gh/gnjo/game-assets@master/megaman-bgm.mp3" type="audio/mpeg">
</audio>

<script>
// 自動播放音樂（點擊後才會成功）
document.body.addEventListener('click',()=>{document.getElementById('bgm').play();},{once:true});

const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');

let cameraX = 0;
let player = {x:100,y:400,w:50,h:70,vx:0,vy:0,onGround:false,facing:1,charge:0,form:'normal',lives:3,invulnerable:0};
let bullets=[],enemies=[],powerups=[],platforms=[],particles=[];
let boss=null;
let level=1,score=0;
let keys={},spawnTimer=0;

const FORMS = {
  normal:   {name:'普通',   color:'#00bfff', shot:'#00ffff'},
  fire:     {name:'火焰',   color:'#ff3000', shot:'#ff8800'},
  electric: {name:'電擊',   color:'#00ff44', shot:'#aaff00'},
  ice:      {name:'冰凍',   color:'#00ffff', shot:'#88ffff'}
};

const LEVELS = [
  [{x:0,y:540,w:5000,h:60},{x:500,y:480,w:250,h:20},{x:1000,y:440,w:200,h:20},{x:1500,y:460,w:300,h:20},{x:2200,y:400,w:250,h:20},{x:3000,y:460,w:400,h:20}],
  [{x:0,y:540,w:5000,h:60},{x:400,y:460,w:200,h:20},{x:900,y:400,w:300,h:20},{x:1500,y:440,w:220,h:20},{x:2200,y:380,w:350,h:20},{x:3000,y:420,w:400,h:20}],
  [{x:0,y:540,w:5000,h:60},{x:600,y:480,w:400,h:20},{x:1300,y:420,w:300,h:20},{x:2000,y:460,w:500,h:20},{x:3000,y:400,w:600,h:20}]
];

function loadLevel(l){
  platforms = LEVELS[l-1];
  enemies = []; powerups = []; boss = null;
  document.getElementById('boss').style.display='none';
  document.getElementById('lvl').textContent = l;

  powerups = [
    {x:800+Math.random()*800,y:300+Math.random()*100,type:'fire'},
    {x:1400+Math.random()*800,y:250+Math.random()*100,type:'electric'},
    {x:2000+Math.random()*600,y:300+Math.random()*100,type:'ice'}
  ];

  if(l===3){
    setTimeout(()=>{ 
      boss = {x:4200,y:340,w:160,h:200,hp:80,maxHp:80,shootTimer:0};
      document.getElementById('boss').style.display='block';
      document.getElementById('bossHp').textContent = 80;
    },2000);
  }
}
loadLevel(1);

document.addEventListener('keydown',e=>keys[e.key.toLowerCase()]=true);
document.addEventListener('keyup',e=>keys[e.key.toLowerCase()]=false);

// 蓄力射擊（蓄力變慢 + 滿蓄金色光環）
function shoot(){
  const isCharged = player.charge >= 280; // 蓄力時間拉長
  const power = isCharged ? 5 : 1;
  const size = isCharged ? 90 : 26;
  const damage = isCharged ? 999 : 1;

  bullets.push({
    x: player.x + (player.facing>0?player.w:0),
    y: player.y + 32,
    vx: player.facing * 22 * power,
    size: size,
    color: isCharged ? '#ffff00' : FORMS[player.form].shot,
    damage: damage,
    trail: isCharged ? 40 : 0
  });
  player.charge = 0;
}

function update(){
  // 移動
  player.vx = 0;
  if(keys['a']){ player.vx = -7; player.facing = -1; }
  if(keys['d']){ player.vx = 7; player.facing = 1; }
  if(keys['w'] && player.onGround) player.vy = -21;

  // 蓄力（變慢）
  if(keys['j']) player.charge = Math.min(player.charge + 8, 300); // 變慢！
  else if(player.charge > 50) shoot();

  player.vy += 0.95;
  player.x += player.vx;
  player.y += player.vy;

  // 平台碰撞
  player.onGround = false;
  platforms.forEach(p=>{
    if(player.x < p.x+p.w && player.x+player.w > p.x && player.y < p.y+p.h && player.y+player.h > p.y && player.vy > 0){
      player.y = p.y - player.h; player.vy = 0; player.onGround = true;
    }
  });

  cameraX = Math.max(0, player.x - 400);

  // 小怪生成（從最右邊）+ 攻擊頻率降低 + 走路變快
  spawnTimer += 16;
  if(spawnTimer > 2500 - level*400){ // 生成變慢
    enemies.push({
      x:4800,y:480,hp:3,maxHp:3,w:44,h:56,
      vx:-(4 + level*1), // 走得更快
      shootTimer:Math.random()*3000 + 2000 // 攻擊間隔2~5秒
    });
    spawnTimer = 0;
  }

  // 小怪AI（攻擊變慢）
  enemies.forEach((e,i)=>{
    e.x += e.vx;
    e.shootTimer += 16;
    if(e.shootTimer > 3000){ // 攻擊頻率大幅降低
      bullets.push({x:e.x+(e.vx>0?e.w:0),y:e.y+30,vx:(player.x>e.x?9:-9),size:24,color:'#ff00ff',damage:1,isEnemy:true});
      e.shootTimer = 0;
    }
    if(e.x < cameraX-200) enemies.splice(i,1);
  });

  // Boss AI（攻擊也變合理）
  if(boss){
    boss.x += Math.sin(Date.now()/1000)*2;
    boss.shootTimer += 16;
    if(boss.shootTimer > 1600){ // 攻擊變慢
      for(let i=-1;i<=1;i++){
        bullets.push({x:boss.x+boss.w/2,y:boss.y+boss.h,vx:(player.x-boss.x)/50+i*4,vy:7,size:40,color:'#ff00ff',damage:2,isEnemy:true});
      }
      boss.shootTimer = 0;
    }
  }

  // 子彈與碰撞（包含扣血）
  bullets.forEach((b,i)=>{
    b.x += b.vx;
    if(b.trail) for(let j=0;j<5;j++) particles.push({x:b.x-j*8,y:b.y,vx:b.vx*0.1,vy:0,color:b.color,life:20});

    if(!b.isEnemy){
      enemies.forEach((e,j)=>{
        if(b.x < e.x+e.w && b.x+b.size > e.x && b.y < e.y+e.h && b.y+b.size > e.y){
          e.hp -= b.damage;
          bullets.splice(i,1);
          if(e.hp<=0){ enemies.splice(j,1); score+=150; createExplosion(e.x+22,e.y+28); }
        }
      });
      if(boss && b.x < boss.x+boss.w && b.x+b.size > boss.x && b.y < boss.y+boss.h && b.y+b.size > boss.y){
        boss.hp -= b.damage; bullets.splice(i,1);
        if(boss.hp<=0){ score+=20000; alert('恭喜擊敗最終BOSS！總分：'+score); location.reload(); }
      }
    }
    else if(player.invulnerable<=0 && b.x < player.x+player.w && b.x+b.size > player.x && b.y < player.y+player.h && b.y+b.size > player.y){
      player.lives--; player.invulnerable = 120;
      bullets.splice(i,1);
      document.getElementById('lives').textContent = player.lives;
      if(player.lives<=0){ alert('遊戲結束！最終分數：'+score); location.reload(); }
      player.x = Math.max(100, player.x-300);
    }
  });

  // 撿道具變身
  powerups = powerups.filter(p=>{
    if(Math.hypot(player.x+25 - (p.x+30), player.y+35 - (p.y+30)) < 80){
      player.form = p.type;
      document.getElementById('weapon').textContent = FORMS[p.type].name;
      createExplosion(p.x+30,p.y+30,FORMS[p.type].color,80);
      return false;
    }
    return true;
  });

  if(player.x > 4600){
    level++; if(level>3){ alert('恭喜全關通關！最終分數：'+score); location.reload(); }
    loadLevel(level); player.x = 100; score += 10000;
  }

  if(player.invulnerable > 0) player.invulnerable--;
  document.getElementById('score').textContent = score;
}

function createExplosion(x,y,color='#ffff00',count=50){
  for(let i=0;i<count;i++){
    const angle = Math.random()*Math.PI*2;
    const speed = 4+Math.random()*12;
    particles.push({x,y,vx:Math.cos(angle)*speed,vy:Math.sin(angle)*speed,color,life:40+Math.random()*30});
  }
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.save();
  ctx.translate(-cameraX,0);

  // 背景星空
  ctx.fillStyle='rgba(255,255,255,0.15)';
  for(let i=0;i<300;i++) ctx.fillRect((i*60 + Date.now()/15)%6000, i*20%540, 2, 2);

  // 平台
  platforms.forEach(p=>{ ctx.fillStyle='#0088ff'; ctx.shadowColor='#00ffff'; ctx.shadowBlur=40; ctx.fillRect(p.x,p.y,p.w,p.h); });
  ctx.shadowBlur=0;

  // 玩家（滿蓄金色光環 + 無敵閃爍）
  if(player.invulnerable===0 || Math.floor(Date.now()/80)%4!==0){
    const c = FORMS[player.form].color;
    ctx.shadowColor = c; ctx.shadowBlur = 50;
    ctx.fillStyle = c; ctx.fillRect(player.x+8,player.y+8,player.w-16,player.h-16);
    ctx.fillStyle = '#ffffff'; ctx.fillRect(player.x+14,player.y+12,player.w-28,16); // 頭盔
    ctx.fillStyle = '#000000'; ctx.fillRect(player.x+18+(player.facing<0?10:0),player.y+18,8,8); // 眼睛
  }

  // 滿蓄力金色光環特效
  if(player.charge >= 280){
    ctx.save();
    ctx.translate(player.x+player.w/2, player.y+player.h/2);
    for(let i=0;i<3;i++){
      ctx.globalAlpha = 0.3 + i*0.2;
      ctx.strokeStyle = '#ffff00';
      ctx.lineWidth = 8+i*6;
      ctx.beginPath();
      ctx.arc(0,0,50+i*20,0,Math.PI*2);
      ctx.stroke();
    }
    ctx.restore();
  }

  // 蓄力條
  if(player.charge>30){
    ctx.fillStyle = player.charge>=280?'#ffff00':'#ffffff';
    ctx.fillRect(player.x-10,player.y-25,(player.charge/300)*(player.w+20),12);
  }
  ctx.shadowBlur=0;

  // 子彈（滿蓄超大金色尾焰）
  bullets.forEach(b=>{
    ctx.shadowColor = b.color; ctx.shadowBlur = b.trail?80:30;
    ctx.fillStyle = b.color;
    ctx.fillRect(b.x,b.y,b.size,b.size);
    if(b.trail){
      for(let i=1;i<10;i++){
        ctx.globalAlpha = i/10;
        ctx.fillRect(b.x-i*b.vx/3,b.y,b.size*0.9,b.size*0.9);
      }
      ctx.globalAlpha=1;
    }
  });
  ctx.shadowBlur=0;

  // 小怪 + 血條
  enemies.forEach(e=>{
    ctx.shadowColor='#ff0088'; ctx.shadowBlur=40;
    ctx.fillStyle='#ff0088'; ctx.fillRect(e.x,e.y,e.w,e.h);
    ctx.shadowBlur=0;
    ctx.fillStyle='#ff0000'; ctx.fillRect(e.x,e.y-18,e.w,10);
    ctx.fillStyle='#00ff00'; ctx.fillRect(e.x,e.y-18,(e.hp/e.maxHp)*e.w,10);
  });

  // Boss
  if(boss){
    ctx.shadowColor='#ff00aa'; ctx.shadowBlur=80;
    ctx.fillStyle='#ff00aa'; ctx.fillRect(boss.x,boss.y,boss.w,boss.h);
    ctx.shadowBlur=0;
    ctx.fillStyle='#ff0000'; ctx.fillRect(boss.x,boss.y-40,boss.w,20);
    ctx.fillStyle='#00ff00'; ctx.fillRect(boss.x,boss.y-40,(boss.hp/boss.maxHp)*boss.w,20);
  }

  // 道具
  powerups.forEach(p=>{
    ctx.save(); ctx.translate(p.x+30,p.y+30); ctx.rotate(Date.now()/200);
    ctx.shadowColor=FORMS[p.type].color; ctx.shadowBlur=80;
    ctx.fillStyle=FORMS[p.type].color;
    ctx.fillRect(-30,-30,60,60); ctx.restore();
  });

  // 粒子
  particles = particles.filter(p=>{
    p.x+=p.vx; p.y+=p.vy; p.life--;
    ctx.globalAlpha = p.life/50;
    ctx.fillStyle = p.color;
    ctx.fillRect(p.x,p.y,12,12);
    return p.life>0;
  });
  ctx.globalAlpha=1;

  ctx.restore();
}

function loop(){ update(); draw(); requestAnimationFrame(loop); }
loop();
</script>
</body>
</html>
