<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>洛克人 – 完美修復版</title>
  <style>
    body {margin:0;background:linear-gradient(to bottom, #001122, #000011);color:#fff;font-family:system-ui,sans-serif;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;overflow:hidden;}
    h1 {color:#00bfff;font-size:48px;margin:20px;text-shadow:0 0 30px #00bfff;}
    canvas {background:linear-gradient(to bottom, #111133, #000022);border:12px solid #00bfff;border-radius:24px;box-shadow:0 0 60px #00bfff,inset 0 0 40px rgba(0,191,255,0.1);}
    #ui {position:absolute;top:20px;left:20px;font-size:28px;text-shadow:0 0 10px #fff;}
    #level {position:absolute;top:20px;right:20px;font-size:28px;text-shadow:0 0 10px #fff;}
    #transform {position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);display:none;align-items:center;justify-content:center;z-index:100;color:#fff;font-size:80px;text-align:center;}
    .info {position:fixed;bottom:20px;color:#aaa;font-size:16px;text-align:center;}
  </style>
</head>
<body>
  <h1>洛克人完美版</h1>
  <div id="ui">
    <div>生命: <span id="lives">3</span></div>
    <div>分數: <span id="score">0</span></div>
  </div>
  <div id="level">關卡: <span id="currentLevel">1</span>/3</div>
  <canvas id="game" width="1200" height="500"></canvas>
  <div id="transform"><div id="transText"></div></div>
  <p class="info">A/D移動 W跳 長按J蓄力射擊（面向方向射） • 撿道具變身 • 右邊進關</p>

  <script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    ctx.imageSmoothingEnabled = true;

    const GRAVITY = 0.9;
    const JUMP_FORCE = -18;
    const MOVE_SPEED = 6;
    const MAX_CHARGE = 300;

    let level = 1;
    let player = {x: 100, y: 350, vx: 0, vy: 0, w: 45, h: 55, lives: 3, facing: 1, charge: 0, charging: false, powerups: {speed:1, shotPower:1}, form: 'normal'};
    let bullets = [];
    let enemies = [];
    let powerups = [];
    let platforms = [];
    let particles = [];
    let score = 0;
    let keys = {};
    let gameRunning = true;
    let enemySpawnTimer = 0;

    const forms = {
      normal: {color: '#00bfff', shot: '#00ffff', name: '正常形態'},
      fire: {color: '#ff3000', shot: '#ff8800', name: '火焰洛克人'},
      electric: {color: '#00ff44', shot: '#aaff00', name: '電擊洛克人'}
    };

    const levels = [
      [{x:0, y:470, w:1200, h:30}, {x:200, y:400, w:200, h:20}, {x:500, y:350, w:150, h:20}, {x:800, y:420, w:180, h:20}, {x:1000, y:380, w:200, h:20}],
      [{x:0, y:470, w:1200, h:30}, {x:150, y:420, w:120, h:20}, {x:350, y:380, w:160, h:20}, {x:550, y:340, w:140, h:20}, {x:750, y:400, w:120, h:20}, {x:950, y:360, w:250, h:20}],
      [{x:0, y:470, w:1200, h:30}, {x:100, y:430, w:100, h:20}, {x:250, y:380, w:120, h:20}, {x:400, y:330, w:100, h:20}, {x:550, y:280, w:140, h:20}, {x:750, y:380, w:120, h:20}, {x:900, y:430, w:300, h:20}]
    ];

    function loadLevel(l) {
      platforms = levels[l-1];
      enemies = [];
      powerups = [{x:400, y:300, type:'form', form:'fire'}, {x:700, y:250, type:'form', form:'electric'}, {x:1000, y:350, type:'form', form:'normal'}];
      enemySpawnTimer = 0;
    }
    loadLevel(1);

    document.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
    document.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

    function showTransform(newForm) {
      document.getElementById('transform').style.display = 'flex';
      document.getElementById('transText').textContent = forms[newForm].name;
      setTimeout(() => {
        player.form = newForm;
        document.getElementById('transform').style.display = 'none';
      }, 1500);
    }

    function update() {
      // 移動
      player.vx = 0;
      if (keys['a']) {player.vx = -MOVE_SPEED * player.powerups.speed; player.facing = -1;}
      if (keys['d']) {player.vx = MOVE_SPEED * player.powerups.speed; player.facing = 1;}
      if (keys['w'] && player.onGround) {player.vy = JUMP_FORCE; player.onGround = false;}

      // 蓄力射擊
      player.charging = keys['j'];
      if (player.charging) {
        player.charge = Math.min(player.charge + 16, MAX_CHARGE);
      } else if (player.charge > 30) {
        // 釋放射擊 - 面向方向
        const power = player.charge / MAX_CHARGE;
        bullets.push({
          x: player.x + (player.facing > 0 ? player.w : 0),
          y: player.y + player.h / 2,
          vx: player.facing * (12 + power * 8),
          vy: 0,
          w: 12 + power * 12,
          h: 12 + power * 12,
          color: forms[player.form].shot
        });
        player.charge = 0;
      }

      player.vy += GRAVITY;
      player.x += player.vx;
      player.y += player.vy;

      // 碰撞平台
      player.onGround = false;
      platforms.forEach(p => {
        if (player.x < p.x + p.w && player.x + player.w > p.x && player.y < p.y + p.h && player.y + player.h > p.y) {
          if (player.vy > 0) {
            player.y = p.y - player.h;
            player.vy = 0;
            player.onGround = true;
          }
        }
      });

      // 邊界
      if (player.x < 0) player.x = 0;
      if (player.y > canvas.height) respawn();

      // 進關
      if (player.x > canvas.width - 150) {
        level++;
        if (level > 3) {
          alert(`恭喜通關！分數：${score}`);
          location.reload();
        } else {
          loadLevel(level);
          player.x = 100;
          score += 1000 * level;
        }
        document.getElementById('currentLevel').textContent = level;
      }

      // 生成敵人
      enemySpawnTimer += 16;
      if (enemySpawnTimer > 2000 - level * 200) {
        enemies.push({x: canvas.width, y: 420, vx: - (2 + level * 0.5), hp: level, maxHp: level, w: 40, h: 50});
        enemySpawnTimer = 0;
      }

      // 子彈更新
      bullets = bullets.filter(b => {
        b.x += b.vx;
        b.y += b.vy;
        return b.x > -50 && b.x < canvas.width + 50;
      });

      // 敵人更新
      enemies.forEach(e => e.x += e.vx);

      // 子彈擊敵
      bullets.forEach((b, bi) => {
        enemies.forEach((e, ei) => {
          if (b.x < e.x + e.w && b.x + b.w > e.x && b.y < e.y + e.h && b.y + b.h > e.y) {
            e.hp -= 1 + player.charge / 100;
            bullets.splice(bi, 1);
            if (e.hp <= 0) {
              enemies.splice(ei, 1);
              score += 100 * level;
            }
          }
        });
      });

      // 敵撞玩家
      enemies.forEach(e => {
        if (player.x < e.x + e.w && player.x + player.w > e.x && player.y < e.y + e.h && player.y + player.h > e.y) {
          respawn();
        }
      });

      // 撿道具變身
      powerups.forEach((pu, pi) => {
        if (player.x < pu.x + pu.w && player.x + player.w > pu.x && player.y < pu.y + pu.h && player.y + player.h > pu.y) {
          showTransform(pu.form);
          powerups.splice(pi, 1);
        }
      });

      document.getElementById('score').textContent = score;
    }

    function respawn() {
      player.lives--;
      player.x = 100;
      player.y = 350;
      player.vx = 0;
      player.vy = 0;
      player.charge = 0;
      if (player.lives <= 0) {
        alert(`遊戲結束！分數：${score}`);
        location.reload();
      }
      document.getElementById('lives').textContent = player.lives;
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // 背景星星
      ctx.fillStyle = 'rgba(255,255,255,0.3)';
      for (let i = 0; i < 80; i++) ctx.fillRect((i*canvas.width/80 + Date.now()/1000 % canvas.width) % canvas.width, (i*canvas.height/80) % canvas.height, 2, 2);

      // 平台
      ctx.fillStyle = '#666';
      platforms.forEach(p => ctx.fillRect(p.x, p.y, p.w, p.h));

      // 玩家 (變身顏色)
      const formColor = forms[player.form].color;
      ctx.shadowColor = formColor;
      ctx.shadowBlur = 25;
      ctx.fillStyle = formColor;
      ctx.fillRect(player.x, player.y, player.w, player.h);
      ctx.shadowBlur = 0;

      // 蓄力條
      if (player.charging) {
        ctx.fillStyle = 'rgba(255,255,255,0.8)';
        ctx.fillRect(player.x, player.y - 20, (player.charge / MAX_CHARGE) * player.w, 10);
      }

      // 子彈
      ctx.shadowBlur = 15;
      bullets.forEach(b => {
        ctx.shadowColor = forms[player.form].shot;
        ctx.fillStyle = forms[player.form].shot;
        ctx.fillRect(b.x, b.y, b.w, b.h);
      });
      ctx.shadowBlur = 0;

      // 敵人 + 血條
      enemies.forEach(e => {
        ctx.fillStyle = '#ff4444';
        ctx.fillRect(e.x, e.y, e.w, e.h);
        ctx.fillStyle = '#ff0000';
        ctx.fillRect(e.x, e.y - 12, e.w, 4);
        ctx.fillStyle = '#00ff00';
        ctx.fillRect(e.x, e.y - 12, (e.hp / e.maxHp) * e.w, 4);
      });

      // 變身道具 (閃爍)
      powerups.forEach(pu => {
        ctx.save();
        ctx.translate(pu.x + pu.w/2, pu.y + pu.h/2);
        ctx.rotate(Date.now() / 500);
        ctx.shadowColor = forms[pu.form].color;
        ctx.shadowBlur = 30;
        ctx.fillStyle = forms[pu.form].color;
        ctx.fillRect(-pu.w/2, -pu.h/2, pu.w, pu.h);
        ctx.restore();
      });
    }

    function loop() {
      update();
      draw();
      requestAnimationFrame(loop);
    }

    loop();
  </script>
</body>
</html>
