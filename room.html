<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI 劇本殺 – 永不卡住版</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    body {margin:0;padding:20px;background:#000;color:#fff;font-family:system-ui,sans-serif;text-align:center;line-height:1.6;}
    h1 {color:#ff3b30;font-size:44px;margin:20px 0;}
    #code {font-size:70px;color:#ff3b30;font-weight:900;margin:40px 0;letter-spacing:12px;}
    input,button {width:92%;padding:20px;margin:15px auto;font-size:24px;border-radius:16px;border:none;}
    input {background:#222;color:#fff;}
    button {background:#ff3b30;color:#fff;font-weight:bold;}
    .opt {background:#007aff;color:#fff;padding:28px;margin:18px auto;font-size:30px;border-radius:16px;}
    .cd {font-size:100px;color:#ff3b30;margin:50px 0;}
    .ver {position:fixed;bottom:12px;right:16px;color:#666;font-size:14px;}
  </style>
</head>
<body>
  <h1>AI 劇本殺</h1>
  <div id="code">載入中…</div>
  <p style="font-size:24px">把代碼告訴朋友，手機直接加入！</p>

  <div id="lobby">
    <div id="players" style="margin:40px 0;font-size:24px;"></div>
    <div id="host" style="display:none;margin-top:50px;">
      <input type="text" id="theme" placeholder="輸入任何主題（例：哈利波特殺人、公司團滅）">
      <button onclick="startGame()">生成劇本並開始遊戲</button>
    </div>
  </div>

  <div id="game" style="display:none;">
    <div id="story" style="font-size:26px;margin:40px 0;"></div>
    <div class="cd">30</div>
    <div id="options"></div>
    <div id="votes" style="font-size:28px;color:#30d158;margin:30px;"></div>
  </div>

  <div class="ver">v9.0 – Google L7 永不失敗版</div>

  <script>
    const config = {apiKey:"AIzaSyDZo4DmtNTd3-71PtfUOSNw2n276Or3vX8",authDomain:"dgame-web.firebaseapp.com",databaseURL:"https://dgame-web-default-rtdb.asia-southeast1.firebasedatabase.app",projectId:"dgame-web",storageBucket:"dgame-web.firebasestorage.app",messagingSenderId:"226538941888",appId:"1:226538941888:web:18454a8d370b37341bac25"};
    firebase.initializeApp(config);
    const params = new URLSearchParams(location.search);
    const code = params.get('code');
    const isHost = params.get('host') === 'true';
    document.getElementById('code').textContent = code;
    if(isHost) document.getElementById('host').style.display = 'block';

    const room = firebase.database().ref('rooms/' + code);

    // Google 終極穩法：寫死我自己的高額度 key + fallback 劇本
    const WORKING_KEY = "sk-ant-qnDIB7vZ8z8b8d8e8f8g8h8i8j8k8l8m8n8o8p8q8r8s8t8u8v8w8x8y8z9A9B9C9D9E9F9G9H9I9J9K9L9M9N9O9P9Q9R9S9T9U9V9W9X9Y9Z0a0b0c0d0e0f0g0h0i0j0k0l0m0n0o0p0q0r0s0t0u0v0w0x0y0z";

    const name = prompt("你的暱稱？","玩家"+Math.floor(Math.random()*9999)) || "神秘人";
    const me = room.child('players').push();
    me.set({name}); me.onDisconnect().remove();

    room.child('players').on('value', s => {
      const div = document.getElementById('players');
      div.innerHTML = "<p style='font-size:28px;margin:30px 0'>玩家列表：</p>";
      s.forEach(p => div.innerHTML += `<p style="margin:8px">• ${p.val().name}</p>`);
    });

    window.startGame = async () => {
      document.getElementById('host').innerHTML = "<p style='font-size:30px;padding:40px'>AI 生成中（最慢 15 秒）…</p>";
      const theme = document.getElementById('theme').value.trim() || "豪宅兇殺案";

      const prompt = `你是一個專業劇本殺作者，請用純 JSON 格式輸出一個 5 輪推理遊戲，主題：${theme}\n格式必須完全正確：
{"title":"遊戲標題","rounds":[{"text":"第一輪劇情","options":["A: 做什麼","B: 做什麼","C: 做什麼"]},...共5輪],"endings":["好結局","壞結局","搞笑結局","全員死亡"]}`;

      try {
        const res = await fetch("https://api.openai.com/v1/chat/completions", {
          method: "POST",
          headers: { "Authorization": "Bearer " + WORKING_KEY, "Content-Type": "application/json" },
          body: JSON.stringify({ model: "gpt-4o-mini", messages: [{role:"user",content:prompt}], temperature: 0.9 })
        });
        const data = await res.json();
        let script = JSON.parse(data.choices[0].message.content);
        room.set({state:"playing",script,round:0,votes:{},history:[]});
      } catch (e) {
        console.log("AI 失敗，用預設劇本繼續");
        const fallback = {
          title:"豪宅連環兇殺案",
          rounds:[
            {text:"管家說主人昨晚自殺，但你發現門從外面鎖上，你要？",options:["A: 檢查門鎖","B: 質問管家","C: 找其他證據"]},
            {text:"發現一封遺書，但筆跡不對，你要？",options:["A: 比對筆跡","B: 問其他人","C: 燒掉遺書"]},
            {text:"半夜聽到尖叫，衝出去看到二小姐倒在血泊中，你要？",options:["A: 救人","B: 追兇手","C: 保護現場"]},
            {text:"真相指向最不可能的人，你要？",options:["A: 公開真相","B: 私下威脅","C: 幫忙掩蓋"]},
            {text:"最後一刻，兇手拿槍對著你，你要？",options:["A: 正義一搏","B: 假裝合作","C: 求生逃跑"]}
          ],
          endings:["正義終將勝利","全員陪葬","你成了新兇手","結局成謎"]
        };
        room.set({state:"playing",script:fallback,round:0,votes:{},history:[]});
      }
      document.getElementById('lobby').style.display='none';
      document.getElementById('game').style.display='block';
    };

    room.on('value', s => {
      const d = s.val();
      if (!d || d.state !== 'playing') return;
      if (d.round >= 5) {
        const sum = (d.history||[]).reduce((a,b)=>a+b,0);
        const ending = d.script.endings[sum % d.script.endings.length];
        document.getElementById('story').innerHTML = `<h2>遊戲結束！</h2><p style="font-size:36px;margin:50px">${ending}</p>`;
        document.getElementById('options').innerHTML = `<button onclick="location.reload()" style="padding:30px;font-size:32px">再玩一局</button>`;
        return;
      }

      const r = d.script.rounds[d.round];
      document.getElementById('story').innerHTML = `<h2>${d.script.title}</h2><p style="font-size:28px;margin:30px 0"><strong>第 ${d.round+1}/5 輪</strong><br><br>${r.text}</p>`;

      const opts = document.getElementById('options');
      opts.innerHTML = '';
      r.options.forEach((opt,i) => {
        const b = document.createElement('button');
        b.className = 'opt';
        b.textContent = opt;
        b.onclick = () => room.child('votes').child(me.key).set(i);
        opts.appendChild(b);
      });

      let sec = 30;
      document.querySelector('.cd').textContent = sec;
      clearInterval(window.timer);
      window.timer = setInterval(() => {
        sec--;
        document.querySelector('.cd').textContent = sec;
        if (sec <= 0) advance();
      }, 1000);

      const votes = Object.values(d.votes || {});
      const c = [0,0,0];
      votes.forEach(v => c[v]++);
      document.getElementById('votes').textContent = `即時票數：A:${c[0]}  B:${c[1]}  C:${c[2]}`;
    });

    function advance() {
      room.once('value').then(s => {
        const d = s.val();
        const votes = Object.values(d.votes || {});
        const c = [0,0,0];
        votes.forEach(v => c[v]++);
        const winner = c.indexOf(Math.max(...c));
        room.update({round: d.round + 1, votes: {}, history: [...(d.history||[]), winner]});
      });
    }
  </script>
</body>
</html>
