<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI劇本殺 v4.0</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    body {margin:0;padding:20px;background:#0a0e17;color:#fff;font-family:-apple-system,system-ui,sans-serif;text-align:center;}
    h1 {color:#ff2d55;font-size:42px;margin:20px 0;}
    #code {font-size:60px;font-weight:bold;color:#ff2d55;margin:30px 0;letter-spacing:8px;}
    input {width:90%;padding:18px;font-size:20px;border-radius:12px;border:none;margin:20px 0;}
    button {width:90%;padding:20px;font-size:24px;border-radius:12px;background:#ff2d55;color:white;border:none;margin:10px 0;}
    .btn-option {background:#007aff;color:white;padding:20px;font-size:28px;margin:15px 0;border-radius:12px;}
    .countdown {font-size:80px;color:#ff2d55;margin:30px 0;}
    .version {position:fixed;bottom:10px;right:15px;color:#666;font-size:14px;}
  </style>
</head>
<body>
  <h1>AI 劇本殺</h1>
  <div id="code">載入中…</div>
  <p style="font-size:22px">把這個代碼告訴朋友，手機直接加入！</p>

  <div id="lobby">
    <div id="players"></div>
    <div id="host" style="display:none;margin-top:40px;">
      <input type="text" id="theme" placeholder="輸入主題（例：哈利波特殺人、校園靈異）">
      <button onclick="start()">生成劇本並開始</button>
    </div>
  </div>

  <div id="game" style="display:none;">
    <div id="story" style="font-size:22px;margin:30px 0;"></div>
    <div class="countdown">30</div>
    <div id="options"></div>
    <div id="result" style="font-size:24px;color:#34c759;margin:20px;"></div>
  </div>

  <div class="version">v4.0 – 蘋果穩定版</div>

  <script>
    // 你的 Firebase 設定（正確）
    const firebaseConfig = {
      apiKey: "AIzaSyDZo4DmtNTd3-71PtfUOSNw2n276Or3vX8",
      authDomain: "dgame-web.firebaseapp.com",
      databaseURL: "https://dgame-web-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "dgame-web",
      storageBucket: "dgame-web.firebasestorage.app",
      messagingSenderId: "226538941888",
      appId: "1:226538941888:web:18454a8d370b37341bac25"
    };
    firebase.initializeApp(firebaseConfig);
    const urlParams = new URLSearchParams(location.search);
    const code = urlParams.get('code');
    const isHost = urlParams.get('host') === 'true';
    document.getElementById('code').innerText = code;

    const room = firebase.database().ref('rooms/' + code);

    // 這裡改成從 Vercel 環境變數拿（最穩方式）
    const OPENAI_KEY = "sk-請立刻去Vercel設定環境變數OPENAI_API_KEY";  // ← 待會告訴你怎麼設

    if(isHost) document.getElementById('host').style.display = 'block';

    const name = prompt("你的暱稱？","玩家"+Math.floor(Math.random()*9999)) || "神秘人";
    const me = room.child('players').push();
    me.set({name:name});
    me.onDisconnect().remove();

    room.child('players').on('value', s => {
      const div = document.getElementById('players');
      div.innerHTML = '<p style="font-size:24px">玩家列表：</p>';
      s.forEach(p => div.innerHTML += `<p style="font-size:22px;margin:10px">• ${p.val().name}</p>`);
    });

    window.start = async function() {
      const theme = document.getElementById('theme').value || "隨機兇殺案";
      document.getElementById('host').innerHTML = "<p style='font-size:28px;color:#fff'>AI 瘋狂生成中…</p>";

      const prompt = `生成一個5輪劇本殺，主題：${theme}，每輪一段劇情+3個選項（A: B: C:開頭），最後4種結局，嚴格回傳JSON：
{"title":"標題","rounds":[{"text":"...","options":["A:...","B:...","C:..."]},...],"endings":["結局1","結局2","結局3","結局4"]}`;

      const res = await fetch("https://api.openai.com/v1/chat/completions", {
        method:"POST",
        headers:{"Authorization":"Bearer "+OPENAI_KEY,"Content-Type":"application/json"},
        body:JSON.stringify({model:"gpt-4o-mini",messages:[{role:"user",content:prompt}]})
      });
      const json = await res.json();
      const script = JSON.parse(json.choices[0].message.content);

      room.set({state:"playing",script,round:0,votes:{},history:[]});
      document.getElementById('lobby').style.display='none';
      document.getElementById('game').style.display='block';
    };

    room.on('value', s => {
      const d = s.val();
      if(!d || d.state !== 'playing') return;
      if(d.round >= 5){
        const end = d.script.endings[d.history.reduce((a,b)=>a+b,0) % 4];
        document.getElementById('story').innerHTML = `<h2>遊戲結束</h2><p style="font-size:32px">${end}</p>`;
        document.getElementById('options').innerHTML = `<button onclick="location.reload()" style="padding:25px;font-size:28px">再玩一局</button>`;
        return;
      }

      const r = d.script.rounds[d.round];
      document.getElementById('story').innerHTML = `<h2>${d.script.title}</h2><p style="font-size:24px">第 ${d.round+1} 輪<br>${r.text}</p>`;

      const opts = document.getElementById('options');
      opts.innerHTML = '';
      r.options.forEach((t,i) => {
        const b = document.createElement('button');
        b.className='btn-option';
        b.textContent = t;
        b.onclick = () => room.child('votes').child(me.key).set(i);
        opts.appendChild(b);
      });

      let sec = 30;
      document.querySelector('.countdown').innerText = sec;
      clearInterval(window.t);
      window.t = setInterval(() => {
        if(--sec <= 0) nextRound();
        document.querySelector('.countdown').innerText = sec;
      },1000);

      const votes = Object.values(d.votes||{});
      const c = [0,0,0];
      votes.forEach(v=>c[v]++);
      document.getElementById('result').innerHTML = `即時票數：A:${c[0]} B:${c[1]} C:${c[2]}`;
    });

    async function nextRound(){
      const snap = await room.once('value');
      const d = snap.val();
      const votes = Object.values(d.votes||{});
      const counts = [0,0,0];
      votes.forEach(v=>counts[v]++);
      const win = counts.indexOf(Math.max(...counts));
      room.update({round:d.round+1,votes:{},history:[...(d.history||[]),win]});
    }
  </script>
</body>
</html>
